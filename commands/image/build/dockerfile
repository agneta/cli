FROM node:8.6.0-slim

RUN apt-get update
RUN apt-get install -y python
RUN apt-get install -y build-essential
RUN apt-get install -y libssh-dev
RUN apt-get install -y libcurl4-gnutls-dev
RUN apt-get install -y git
RUN apt-get install -y graphicsmagick

# Enviroment variables
ENV HOME=<%-config.path.home%>
ARG AGNETA_SECRET_KEY=3
#ENV REGISTRY=http://192.168.0.100:8081/nexus/content/repositories/npm-proxy/

#RUN npm config set registry $REGISTRY
RUN npm config set registry https://registry.npmjs.org/
RUN npm config set cache /.cache/npm --global
<%-cli%>


COPY . <%-config.path.app%>
WORKDIR <%-config.path.app%>

RUN agneta image setup

# Copy npm cache and install packages
ADD <%-config.path.npmCache%> /
ADD package.json package-lock.json /tmp/
RUN cd /tmp && npm install --prefer-offline --loglevel info
RUN mkdir -p <%-config.path.app%> && cd <%-config.path.app%> && ln -s /tmp/node_modules

# Start Agneta
CMD ["agneta", "process", "start"]
