FROM node:8-alpine

RUN apk -v --update add \
        python \
        openssh \
        build-base \
        libssh-dev \
        git \
        graphicsmagick \
        bash \
        libc6-compat \
        gawk \
        sed \
        grep \
        bc \
        coreutils \
        su-exec \
        && \
    apk -v --purge del py-pip && \
    rm /var/cache/apk/*

# Enviroment variables

ARG AGNETA_SECRET_KEY=3

# ---------------------------------------------------
# Setup workspace

COPY . <%-config.path.app%>
WORKDIR <%-config.path.app%>

<%-config.commands.npm%>
<%-config.commands.cli%>

RUN agneta image setup
RUN npm config set cache <%-config.path.home%>/.cache/npm --global

# ---------------------------------------------------
# Configure Agneta user

ENV HOME=<%-config.path.home%>
ENV USER=<%-config.user.username%>
ENV USER_ID=<%-config.user.uid%>
ENV GROUP_ID=<%-config.user.gid%>

RUN USER_ID=${USER_ID:-9001} && \
    GROUP_ID=${GROUP_ID:-9001} && \
    mv /root/.ssh $HOME/.ssh && \
    deluser --remove-home node && \
    addgroup -S -g $GROUP_ID $USER && \
    adduser -S -u $USER_ID -G $USER $USER && \
    chown -R $USER:$USER $HOME

USER <%-config.user.username%>

#------------------------------------------------------------
# BEGIN NPM

RUN npm install --prefer-offline --loglevel info

#------------------------------------------------------------
# Start

CMD ["agneta", "process", "start"]
